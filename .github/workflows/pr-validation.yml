name: PR Validation

on:
  pull_request:
    types: [ opened, synchronize, reopened, ready_for_review ]

jobs:
  pr-checks:
    name: PR Quality Checks
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'

      - name: Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            build
            ci
            chore
            revert

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q "<<<<<" && echo "Merge conflict detected" && exit 1 || echo "No merge conflicts"

      - name: Validate code formatting
        run: mvn fmt:check -B
        continue-on-error: true

      - name: Check for TODOs in code
        run: |
          if grep -r "TODO" src/main --include="*.java"; then
            echo "Warning: TODO comments found in main code"
          fi

      - name: Verify no System.out.println in production code
        run: |
          if grep -r "System.out.println" src/main --include="*.java"; then
            echo "Error: System.out.println found in production code"
            exit 1
          fi

      - name: Check JavaDoc coverage
        run: mvn javadoc:javadoc -B

      - name: Validate Maven POM
        run: mvn validate -B

      - name: Check for license headers
        run: mvn license:check -B
        continue-on-error: true

  size-label:
    name: PR Size Labeling
    runs-on: ubuntu-latest

    steps:
      - uses: codelytv/pr-size-labeler@v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          xs_label: 'size/XS'
          xs_max_size: '10'
          s_label: 'size/S'
          s_max_size: '100'
          m_label: 'size/M'
          m_max_size: '500'
          l_label: 'size/L'
          l_max_size: '1000'
          xl_label: 'size/XL'
          fail_if_xl: 'false'

  changed-files:
    name: Detect Changed Files
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files: |
            src/**/*.java
            pom.xml
            .github/workflows/**

      - name: List changed files
        run: |
          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"